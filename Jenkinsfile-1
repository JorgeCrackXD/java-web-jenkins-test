pipeline {
  agent none
  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }
  stages {
    stage('Scan') {
      agent {
        docker {
          image 'maven:3.6.3-jdk-11'
        }
      } 
      steps {
        withSonarQubeEnv(installationName: 'sonar') { 
          sh 'mvn clean org.sonarsource.scanner.maven:sonar-maven-plugin:3.9.0.2155:sonar'
        }
      }
    }
    stage("Build Jar File"){
      agent {
        docker {
          image 'maven:3.6.3-jdk-11'
        }
      }
      steps {
        dir('/var/jenkins_home/workspace/test-task') {
          sh 'mvn -U -Dmaven.test.skip=true clean install'
        }
      }
    }
    stage("Upload to Nexus"){
      agent {
        docker {
          image 'maven:3.6.3-jdk-11'
        }
      }
      steps {
        script {
          dir ('/var/jenkins_home/workspace/test-task') {
            def pomBuild = readMavenPom file: 'pom.xml'
            def type = "jar"
            def repository = "maven-snapshots"
            def env="-loc"
            nexusPublisher nexusInstanceId: 'nexus',
            nexusRepositoryId: "${repository}",
            packages: [[$class: 'MavenPackage',
            mavenAssetList: [[classifier: '', extension: '', filePath: "target/${pomBuild.artifactId}-${pomBuild.version}.${type}"]],
            mavenCoordinate: [
                artifactId: "${pomBuild.artifactId}",
                groupId: "${pomBuild.groupId}",
                packaging: "${type}",
                version: "${pomBuild.version}${env}"]
            ]]
          }
        }
      }
    }
  }
}
